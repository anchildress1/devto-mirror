name: Deploy to GitHub Pages

on:
  push:
    branches:
      - gh-pages

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages-deployment
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout gh-pages branch
        uses: actions/checkout@v6
        with:
          ref: gh-pages

      - name: Prepare deployment artifact
        run: |
          echo "## ðŸ“¦ Preparing GitHub Pages Deployment" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“ Source Branch: gh-pages" >> $GITHUB_STEP_SUMMARY

          mkdir -p _site

          # Extract username for URL construction
          username=$(echo ${{ github.repository }} | cut -d'/' -f1)
          ROOT_HOME="https://$username.github.io/"

          # Copy and substitute robots.txt from assets
          if [ -f assets/robots.txt ]; then
            cp assets/robots.txt _site/robots.txt
            sed -i "s|{home}|$ROOT_HOME|g" _site/robots.txt
            sed -i "s|{root_home}|$ROOT_HOME|g" _site/robots.txt
            echo "  âœ… robots.txt" >> $GITHUB_STEP_SUMMARY
          else
            echo "  âš ï¸ assets/robots.txt not found" >> $GITHUB_STEP_SUMMARY
          fi

          # Copy sitemap if it exists
          if [ -f sitemap.xml ]; then
            cp sitemap.xml _site/
            echo "  âœ… sitemap.xml" >> $GITHUB_STEP_SUMMARY
          fi

          # Copy llms.txt from assets
          if [ -f assets/llms.txt ]; then
            cp assets/llms.txt _site/llms.txt
            sed -i "s|{home}|$ROOT_HOME|g" _site/llms.txt
            sed -i "s|{root_home}|$ROOT_HOME|g" _site/llms.txt
            echo "  âœ… llms.txt" >> $GITHUB_STEP_SUMMARY
          else
            echo "  âš ï¸ assets/llms.txt not found" >> $GITHUB_STEP_SUMMARY
          fi

          # Copy Google verification file
          if [ -f google6b80426bb396f31f.html ]; then
            cp google6b80426bb396f31f.html _site/
            echo "  âœ… google6b80426bb396f31f.html" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Deployment artifact prepared" >> $GITHUB_STEP_SUMMARY

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: _site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Deployment summary
        if: success()
        run: |
          echo "## ðŸš€ Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŒ Deployed to: ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- â±ï¸ Completed at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
