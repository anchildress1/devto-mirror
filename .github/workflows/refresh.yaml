name: Refresh All Posts and Comments

on:
  workflow_dispatch:
    inputs:
      backup_branch:
        description: 'Name for backup branch (default: backup-YYYYMMDD-HHMMSS)'
        required: false
        type: string

permissions:
  contents: write
  actions: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  refresh:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"
          python-version: "3.12"

      - name: Create backup branch
        run: |
          # This backs up the PROJECT site's gh-pages branch (devto-mirror repo)
          # Generate backup branch name if not provided
          if [ -z "${{ inputs.backup_branch }}" ]; then
            BACKUP_BRANCH="backup-$(date +%Y%m%d-%H%M%S)"
          else
            BACKUP_BRANCH="${{ inputs.backup_branch }}"
          fi

          echo "BACKUP_BRANCH=$BACKUP_BRANCH" >> $GITHUB_ENV
          echo "Creating backup branch: $BACKUP_BRANCH"

          # Configure git
          git config user.name "ci-bot"
          git config user.email "actions@users.noreply.github.com"

          # Fetch all branches to ensure we have the latest state
          git fetch --all --prune || true

          # Check if gh-pages branch exists and has content to backup
          if git rev-parse --verify origin/gh-pages >/dev/null 2>&1; then
            echo "Found gh-pages branch, creating backup..."
            git checkout gh-pages
            git reset --hard origin/gh-pages

            # Create backup branch from current gh-pages state
            git checkout -b "$BACKUP_BRANCH"
            git push origin "$BACKUP_BRANCH"
            echo "âœ… Backup created in branch: $BACKUP_BRANCH"

            # Return to main branch
            git checkout main

            echo "## ðŸ”„ Refresh Workflow Started" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Backup created: \`$BACKUP_BRANCH\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸  No gh-pages branch found, skipping backup"
            echo "## ðŸ”„ Refresh Workflow Started" >> $GITHUB_STEP_SUMMARY
            echo "- â„¹ï¸  No existing gh-pages branch to backup" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Reset last run timestamp
        run: |
          echo "ðŸ”„ Resetting last run timestamp to force full regeneration..."

          # Remove last_run.txt if it exists to force full regeneration
          if [ -f last_run.txt ]; then
            rm last_run.txt
            echo "Removed existing last_run.txt"
            echo "- âœ… Reset timestamp in main branch" >> $GITHUB_STEP_SUMMARY
          else
            echo "- â„¹ï¸  No timestamp file in main branch" >> $GITHUB_STEP_SUMMARY
          fi

          # Also check and reset timestamp in gh-pages if it exists
          if git rev-parse --verify origin/gh-pages >/dev/null 2>&1; then
            git checkout gh-pages
            git reset --hard origin/gh-pages

            if [ -f last_run.txt ]; then
              rm last_run.txt
              git add -A
              git commit -m "chore: reset last_run.txt for full refresh" || echo "No changes to commit"
              git push origin gh-pages
              echo "Reset last_run.txt in gh-pages branch"
              echo "- âœ… Reset timestamp in gh-pages branch" >> $GITHUB_STEP_SUMMARY
            else
              echo "- â„¹ï¸  No timestamp file in gh-pages branch" >> $GITHUB_STEP_SUMMARY
            fi

            git checkout main
          fi

      - name: Trigger publish workflow
        run: |
          echo "ðŸš€ Triggering the main publish workflow for full regeneration..."
          echo "â„¹ï¸  This regenerates the devto-mirror PROJECT site"
          echo "â„¹ï¸  Root site (username.github.io) updates automatically if ROOT_SITE_PAT is set"

          # Verify DEVTO_USERNAME is set
          if [ -z "${{ vars.DEVTO_USERNAME }}" ]; then
            echo "âŒ ERROR: DEVTO_USERNAME repository variable is not set!"
            echo "The publish workflow will be skipped without this variable."
            echo "Set it at: Settings â†’ Actions â†’ Variables â†’ DEVTO_USERNAME"
            exit 1
          fi

          # Trigger the workflow
          gh workflow run publish.yaml \
            --ref main \
            -f force_full_regen=true

          # Wait a moment for workflow to register
          sleep 5

          # Get the workflow run ID
          RUN_ID=$(gh run list --workflow=publish.yaml --limit 1 --json databaseId --jq '.[0].databaseId')

          echo "âœ… Publish workflow triggered successfully"
          echo "ðŸ” Monitor the workflow at: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${RUN_ID}"
          echo "ðŸ“¦ Backup available in branch: $BACKUP_BRANCH"

          echo "## ðŸš€ Workflow Triggered" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Publish workflow started for full regeneration" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ†” Run ID: \`${RUN_ID}\`" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” [Monitor progress](${{ github.server_url }}/${{ github.repository }}/actions/runs/${RUN_ID})" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ Backup branch: \`$BACKUP_BRANCH\`" >> $GITHUB_STEP_SUMMARY
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
