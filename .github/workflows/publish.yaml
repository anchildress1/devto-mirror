name: Generate and Publish Dev.to Mirror Site

# Required repository variables:
# - DEVTO_USERNAME: Your Dev.to username (required)
# - GH_USERNAME: Your GitHub username (required)
#   - Used for constructing GitHub Pages URLs
#
# Optional repository secrets:
# - DEVTO_KEY: Dev.to API key (optional for public content, required for private/draft posts)

on:
  schedule:
    - cron: "40 14 * * 3"  # At 9:40 AM EST every Wednesday
  push:
    branches:
      - main
    paths:
      - '.github/workflows/publish.yaml'
  workflow_dispatch:
    inputs:
      force_full_regen:
        description: 'Force full regeneration'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  generate-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment:
      name: deploy
      url: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}
    env:
      DEVTO_USERNAME: ${{ vars.DEVTO_USERNAME }}
      GH_USERNAME: ${{ vars.GH_USERNAME }}
      DEVTO_KEY: ${{ secrets.DEVTO_KEY }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Restore last run timestamp
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          if git ls-remote --exit-code origin gh-pages >/dev/null 2>&1; then
            git fetch origin gh-pages --depth=1
            if git show origin/gh-pages:last_run.txt >/dev/null 2>&1; then
              TIMESTAMP=$(git show origin/gh-pages:last_run.txt)
              echo "$TIMESTAMP" > last_run.txt
              echo "ðŸ”„ Restored last_run.txt from gh-pages: \`$TIMESTAMP\`" >> $GITHUB_STEP_SUMMARY
            else
              echo "âš ï¸ last_run.txt not found on gh-pages branch" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "ðŸ†• gh-pages branch does not exist yet; skipping last_run restore" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Set up uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"
          python-version: "3.12"

      - name: Cache uv dependencies
        uses: actions/cache@v5
        with:
          path: ~/.cache/uv
          key: ${{ runner.os }}-uv-${{ hashFiles('**/uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-uv-

      - name: Install dependencies
        run: uv sync --locked --group dev

      - name: Run post-install setup
        run: make install

      - name: Generate site
        env:
          PAGES_REPO: ${{ github.repository }}
          FORCE_FULL_REGEN: ${{ github.event.inputs.force_full_regen || 'false' }}
        run: |
          echo "## ðŸ—ï¸ Site Generation" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ‘¤ Dev.to: \`${DEVTO_USERNAME}\`" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ Repo: \`${{ github.repository }}\`" >> $GITHUB_STEP_SUMMARY
          uv run python scripts/generate_site.py
          echo "âœ… Generated" >> $GITHUB_STEP_SUMMARY

      - name: Validate generated site
        run: |
          echo "## âœ… Site Validation" >> $GITHUB_STEP_SUMMARY
          uv run python scripts/validate_site_generation.py
          echo "âœ… Validation passed" >> $GITHUB_STEP_SUMMARY

      - name: Generate sitemap and index
        run: |
          echo "## ðŸ“„ Generating Sitemap" >> $GITHUB_STEP_SUMMARY
          uv run python scripts/render_index_sitemap.py
          echo "âœ… Sitemap generated" >> $GITHUB_STEP_SUMMARY

      - name: Prepare deployment directory
        env:
          GH_USERNAME: ${{ vars.GH_USERNAME }}
        run: |
          mkdir -p _deploy
          cp .nojekyll _deploy/
          cp index.html _deploy/
          cp posts_data.json _deploy/
          cp -R posts _deploy/
          [ -d comments ] && cp -R comments _deploy/
          [ -f last_run.txt ] && cp last_run.txt _deploy/
          [ -f comments.txt ] && cp comments.txt _deploy/

          # Add static config files
          [ -f sitemap.xml ] && cp sitemap.xml _deploy/
          [ -f google6b80426bb396f31f.html ] && cp google6b80426bb396f31f.html _deploy/

          # Process template files
          SITE_HOME="https://${GH_USERNAME}.github.io/devto-mirror/"
          sed "s|{root_home}|$SITE_HOME|g" assets/robots.txt > _deploy/robots.txt
          sed "s|{root_home}|$SITE_HOME|g" assets/llms.txt > _deploy/llms.txt

      - name: Snapshot gh-pages branch
        id: snapshot-gh-pages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          git config --global user.name "ci-bot"
          git config --global user.email "actions@users.noreply.github.com"
          SNAPSHOT_DIR=$(mktemp -d)
          git clone --depth 1 --branch gh-pages "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}" "$SNAPSHOT_DIR"
          find "$SNAPSHOT_DIR" -mindepth 1 -maxdepth 1 -not -name '.git' -exec rm -rf {} +
          rsync -a _deploy/ "$SNAPSHOT_DIR"/
          cd "$SNAPSHOT_DIR"
          git add -A
          if git diff --cached --quiet; then
            echo "No gh-pages updates"
            echo "snapshot_changed=false" >> "$GITHUB_OUTPUT"
          else
            git commit -m "chore: snapshot generated site"
            git push origin gh-pages
            echo "snapshot_changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Deploy to gh-pages
        if: steps.snapshot-gh-pages.outputs.snapshot_changed == 'true'
        timeout-minutes: 5
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./_deploy
          publish_branch: gh-pages
          force_orphan: false
          user_name: ci-bot
          user_email: actions@users.noreply.github.com
          commit_message: 'chore: deploy dev.to mirror'
