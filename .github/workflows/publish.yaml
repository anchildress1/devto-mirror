name: Dev.to Mirror

on:
  schedule:
    - cron: "38 13 * * 3"   # runs weekly Wed at 13:38 UTC (09:38 AM EDT)
  workflow_dispatch: {}

permissions:
  pages: write
  id-token: write
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    # Run on the repository's default branches and manual dispatches. We no longer
    # special-case `gh-pages` because we deploy via the Pages actions (artifact
    # + API) rather than pushing to the branch directly.
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v6.0.0
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Install dependencies
        # Use pip to install the package in editable mode instead of running
        # an external install script. This avoids executing remote shell code.
        run: python -m pip install -e .

      - name: Generate site
        env:
          DEVTO_USERNAME: ${{ vars.DEVTO_USERNAME }}  # single variable only
          PAGES_REPO: ${{ github.repository }}        # "username/repo"
          FORCE_FULL_REGEN: "true"                    # Force full regeneration to ensure all files are created
        run: python scripts/generate_site.py
      # Use official GitHub Pages actions to deploy the generated site as an artifact
      # This avoids manual gh-pages branch management and uses the Pages API.
      - name: Configure GitHub Pages
        uses: actions/configure-pages@v3

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v1
        with:
          path: |
            .nojekyll
            index.html
            comments.txt
            robots.txt
            sitemap.xml
            posts
            posts_data.json
            scripts

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v1

# Generated with the help of ChatGPT and GitHub Copilot.
