name: Generate and Publish Dev.to Mirror Site

# This workflow has TWO deployment jobs:
# 1. generate-and-deploy: Deploys full mirror site to THIS repo's gh-pages branch
# 2. deploy-root-config: Deploys 4 static files to <username>/<username> repo's gh-pages branch
#
# Required repository variables:
# - DEVTO_USERNAME: Your Dev.to username (required)
# - GH_USERNAME: Your GitHub username (required)
#   - Used for constructing GitHub Pages URLs
#
# Optional repository secrets:
# - DEVTO_API_KEY: Dev.to API key (optional for public content, required for private/draft posts)
# - ROOT_SITE_PAT: Personal Access Token for deploying to root repo (optional)
#   - If not set, root deployment will be skipped
#   - Required scopes: 'repo' (classic) or 'contents: write' (fine-grained)
#   - Used to deploy to: https://github.com/<username>/<username>

on:
  schedule:
    - cron: "40 14 * * 3"  # At 9:40 AM EST every Wednesday
  workflow_dispatch:
    inputs:
      force_full_regen:
        description: 'Force full regeneration'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  generate-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: vars.DEVTO_USERNAME != ''
    environment:
      name: deploy
      url: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}
    env:
      DEVTO_USERNAME: ${{ vars.DEVTO_USERNAME }}
      GH_USERNAME: ${{ vars.GH_USERNAME }}
      DEVTO_API_KEY: ${{ secrets.DEVTO_API_KEY }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"
          python-version: "3.12"

      - name: Cache uv dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: ${{ runner.os }}-uv-${{ hashFiles('**/uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-uv-

      - name: Install dependencies
        run: uv sync --locked --group dev

      - name: Run post-install setup
        run: make install

      - name: Generate site
        env:
          PAGES_REPO: ${{ github.repository }}
          FORCE_FULL_REGEN: ${{ github.event.inputs.force_full_regen || 'false' }}
        run: |
          echo "## ðŸ—ï¸ Site Generation" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ‘¤ Dev.to: \`${DEVTO_USERNAME}\`" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ Repo: \`${{ github.repository }}\`" >> $GITHUB_STEP_SUMMARY
          make generate-site
          echo "âœ… Generated" >> $GITHUB_STEP_SUMMARY

      - name: Validate generated site
        run: |
          echo "## âœ… Site Validation" >> $GITHUB_STEP_SUMMARY
          uv run python scripts/validate_site_generation.py
          echo "âœ… Validation passed" >> $GITHUB_STEP_SUMMARY

      - name: Generate sitemap and index
        run: |
          echo "## ðŸ“„ Generating Sitemap" >> $GITHUB_STEP_SUMMARY
          uv run python scripts/render_index_sitemap.py
          echo "âœ… Sitemap generated" >> $GITHUB_STEP_SUMMARY

      - name: Prepare root site config files
        env:
          GH_USERNAME: ${{ vars.GH_USERNAME }}
        run: |
          echo "## ðŸŒ Root Site Config Update" >> $GITHUB_STEP_SUMMARY
          echo "Preparing root config bundle" >> $GITHUB_STEP_SUMMARY

          mkdir -p root_config
          # Use GH_USERNAME for root site only
          ROOT_HOME="https://${GH_USERNAME}.github.io/"

          cp assets/robots.txt root_config/robots.txt
          sed -i "s|{root_home}|$ROOT_HOME|g" root_config/robots.txt

          cp assets/llms.txt root_config/llms.txt
          sed -i "s|{root_home}|$ROOT_HOME|g" root_config/llms.txt

          if [ -f sitemap.xml ]; then
            cp sitemap.xml root_config/sitemap.xml
            echo "âœ… Sitemap copied to root config" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No sitemap.xml found" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f google6b80426bb396f31f.html ]; then
            cp google6b80426bb396f31f.html root_config/
          fi

      - name: Upload root config artifact
        uses: actions/upload-artifact@v4
        with:
          name: root-config
          path: root_config

      - name: Prepare deployment directory
        run: |
          mkdir -p _deploy
          cp .nojekyll _deploy/
          cp index.html _deploy/
          cp posts_data.json _deploy/
          cp -R posts _deploy/
          [ -d comments ] && cp -R comments _deploy/
          [ -f last_run.txt ] && cp last_run.txt _deploy/
          [ -f comments.txt ] && cp comments.txt _deploy/

      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./_deploy
          publish_branch: gh-pages
          force_orphan: false
          user_name: ci-bot
          user_email: actions@users.noreply.github.com
          commit_message: 'chore: deploy dev.to mirror'

  deploy-root-config:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: generate-and-deploy
    if: vars.DEVTO_USERNAME != '' && vars.GH_USERNAME != ''
    environment: deploy
    env:
      DEVTO_USERNAME: ${{ vars.DEVTO_USERNAME }}
      GH_USERNAME: ${{ vars.GH_USERNAME }}
      ROOT_SITE_PAT: ${{ secrets.ROOT_SITE_PAT }}
    steps:
      - name: Download root config artifact
        uses: actions/download-artifact@v6
        with:
          name: root-config
          path: root_config

      - name: Check root config changes
        id: root_config_changed
        if: env.ROOT_SITE_PAT != ''
        run: |
          set -eo pipefail

          TMP_REPO="$(mktemp -d)"
          # Use GH_USERNAME for root repo
          REPO_URL="https://github.com/${GH_USERNAME}/${GH_USERNAME}.git"

          if git ls-remote --exit-code "$REPO_URL" gh-pages >/dev/null 2>&1; then
            git clone --depth 1 --branch gh-pages "$REPO_URL" "$TMP_REPO" 2>&1 | grep -v "Cloning into" || true
          else
            git clone --depth 1 "$REPO_URL" "$TMP_REPO" 2>&1 | grep -v "Cloning into" || true
            (cd "$TMP_REPO" && git checkout --orphan gh-pages && git rm -rf . >/dev/null 2>&1 || true)
          fi

          FILES=(robots.txt llms.txt sitemap.xml google6b80426bb396f31f.html)
          changed=false
          for file in "${FILES[@]}"; do
            new_file="root_config/$file"
            old_file="$TMP_REPO/$file"

            if [ -f "$new_file" ]; then
              if [ ! -f "$old_file" ] || ! cmp -s "$new_file" "$old_file"; then
                changed=true
                break
              fi
            elif [ -f "$old_file" ]; then
              changed=true
              break
            fi
          done

          echo "changed=$changed" >> $GITHUB_OUTPUT

      - name: Deploy root config via GitHub Pages action
        if: steps.root_config_changed.outputs.changed == 'true'
        uses: peaceiris/actions-gh-pages@v4
        with:
          personal_token: ${{ env.ROOT_SITE_PAT }}
          publish_dir: root_config
          publish_branch: gh-pages
          keep_files: true
          destination_dir: .
          external_repository: ${{ env.GH_USERNAME }}/${{ env.GH_USERNAME }}
          user_name: ci-bot
          user_email: actions@users.noreply.github.com

      - name: Skip root deployment (no changes)
        if: steps.root_config_changed.outputs.changed != 'true' && env.ROOT_SITE_PAT != ''
        run: |
          echo "Skipping root deployment (no file changes detected)"

      - name: Skip root deployment (missing ROOT_SITE_PAT)
        if: env.ROOT_SITE_PAT == ''
        run: |
          echo "Skipping root deployment (ROOT_SITE_PAT not configured)"
